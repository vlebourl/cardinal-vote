name: Docker Compose Configuration Tests

on:
  push:
    branches: [main, develop/generalized-platform]
    paths:
      - 'docker-compose*.yml'
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - '.github/workflows/docker-compose-test.yml'
  pull_request:
    branches: [main, develop/generalized-platform]
    paths:
      - 'docker-compose*.yml'
      - 'Dockerfile'
      - 'docker-entrypoint.sh'
      - '.github/workflows/docker-compose-test.yml'

jobs:
  test-docker-compose-configurations:
    name: Test Docker Compose Configurations
    runs-on: ubuntu-latest

    strategy:
      matrix:
        config:
          - name: 'Test Environment'
            file: 'docker-compose.test.yml'
            service: 'postgres-test'
            healthcheck: true
          - name: 'Main Environment (Development/Production)'
            file: 'docker-compose.yml'
            service: 'postgres'
            healthcheck: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create required environment files
        run: |
          # Create minimal .env for testing
          cat > .env << EOF
          # Required security variables for Docker Compose validation
          POSTGRES_PASSWORD=ci_test_password_32_chars_minimum_length_requirement
          SUPER_ADMIN_EMAIL=ci-test@example.com
          SUPER_ADMIN_PASSWORD=ci_test_super_admin_password_32_chars_minimum_length_requirement
          JWT_SECRET_KEY=ci_test_jwt_secret_key_extremely_long_for_testing_64_chars_minimum_abcdef

          # Application configuration
          CARDINAL_ENV=test
          DEBUG=false
          HOST=0.0.0.0
          PORT=8000

          # Test database configuration
          POSTGRES_DB=cardinal_vote
          POSTGRES_USER=cardinal_user

          # Security settings
          ENABLE_RATE_LIMITING=false
          MAX_VOTES_PER_IP_PER_HOUR=1000
          EOF

          # Create secrets directory for production testing
          mkdir -p secrets
          echo "ci_test_db_password_32_chars_minimum" > secrets/db_password.txt
          echo "ci_test_grafana_password_32_chars_min" > secrets/grafana_password.txt

      - name: Validate Docker Compose file syntax
        run: |
          echo "üîç Validating ${{ matrix.config.file }} syntax..."
          docker compose -f ${{ matrix.config.file }} config --quiet
          echo "‚úÖ Docker Compose file syntax is valid"

      - name: Test Docker Compose service definition
        run: |
          echo "üîç Testing ${{ matrix.config.name }} service definitions..."

          # Check if the main service is properly defined
          if docker compose -f ${{ matrix.config.file }} config | grep -q "${{ matrix.config.service }}:"; then
            echo "‚úÖ Service '${{ matrix.config.service }}' is properly defined"
          else
            echo "‚ùå Service '${{ matrix.config.service }}' not found in configuration"
            exit 1
          fi

      - name: Test database service startup (with timeout)
        if: matrix.config.healthcheck
        run: |
          echo "üöÄ Testing ${{ matrix.config.name }} database startup..."

          # Start database service only
          docker compose -f ${{ matrix.config.file }} up -d ${{ matrix.config.service }}

          # Wait for health check with timeout
          echo "‚è≥ Waiting for database health check (max 60s)..."
          timeout=60
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            if docker compose -f ${{ matrix.config.file }} ps | grep -q "healthy"; then
              echo "‚úÖ Database service is healthy after ${elapsed}s"
              break
            elif [ $elapsed -ge $timeout ]; then
              echo "‚ùå Database health check timed out after ${timeout}s"
              docker compose -f ${{ matrix.config.file }} logs ${{ matrix.config.service }}
              exit 1
            fi

            sleep 2
            elapsed=$((elapsed + 2))
            echo "   - Health check attempt at ${elapsed}s..."
          done

      - name: Test environment variable validation
        run: |
          echo "üîç Testing environment variable validation..."

          # Test that required security variables are validated for main docker-compose.yml
          if [[ "${{ matrix.config.file }}" == "docker-compose.yml" ]]; then
            echo "Testing main docker-compose.yml environment variable handling..."

            # Create invalid .env with missing required vars
            mv .env .env.backup
            cat > .env << EOF
          # Missing required security variables - should fail validation in production mode
          POSTGRES_DB=cardinal_vote
          POSTGRES_USER=cardinal_user
          # POSTGRES_PASSWORD intentionally missing for validation test
          EOF

            # Test configuration validation (this should work but warn about missing production vars)
            if docker compose -f ${{ matrix.config.file }} config >/dev/null 2>&1; then
              echo "‚úÖ Configuration parsed successfully (uses fallback values in development mode)"
            else
              echo "‚ö†Ô∏è Configuration parsing failed - this may indicate syntax issues"
            fi

            # Restore valid .env
            mv .env.backup .env
          fi

      - name: Test basic database connectivity
        if: matrix.config.healthcheck
        run: |
          echo "üîå Testing database connectivity..."

          # Test database connection
          if [[ "${{ matrix.config.file }}" == *"test"* ]]; then
            # Test environment uses different port and credentials
            docker run --rm --network container:$(docker compose -f ${{ matrix.config.file }} ps -q ${{ matrix.config.service }}) \
              postgres:16-alpine pg_isready -h localhost -p 5432 -U test_user -d test_cardinal_vote
          else
            # Other environments use standard credentials
            docker run --rm --network container:$(docker compose -f ${{ matrix.config.file }} ps -q ${{ matrix.config.service }}) \
              postgres:16-alpine pg_isready -h localhost -p 5432 -U cardinal_user -d cardinal_vote
          fi

          echo "‚úÖ Database connectivity test passed"

      - name: Clean up
        if: always()
        run: |
          echo "üßπ Cleaning up test containers..."
          docker compose -f ${{ matrix.config.file }} down --volumes --remove-orphans || true
          docker system prune -f || true

      - name: Display logs on failure
        if: failure()
        run: |
          echo "üìã Container logs for debugging:"
          docker compose -f ${{ matrix.config.file }} logs || true
          echo ""
          echo "üìã System information:"
          docker version
          docker compose version
          df -h
