{% extends "admin/base.html" %}

{% block title %}Gestion des logos{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <h1 class="page-title">
            <i class="fas fa-images"></i>
            Gestion des logos
        </h1>
        <p class="page-subtitle">Upload, suppression et organisation des logos</p>
    </div>

    <!-- Upload Section -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-upload"></i>
                Ajouter un nouveau logo
            </h2>
        </div>
        <div class="card-content">
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                <div class="form-row">
                    <div class="form-group">
                        <label for="logoFile" class="form-label">
                            <i class="fas fa-file-image"></i>
                            Fichier PNG (max {{ max_upload_size_mb }}MB)
                        </label>
                        <input
                            type="file"
                            id="logoFile"
                            name="file"
                            class="form-input"
                            accept=".png"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="newName" class="form-label">
                            <i class="fas fa-tag"></i>
                            Nouveau nom (optionnel)
                        </label>
                        <input
                            type="text"
                            id="newName"
                            name="new_name"
                            class="form-input"
                            placeholder="ex: cardinal12.png"
                            pattern="^cardinal.*\.png$"
                        >
                        <small class="form-help">Doit commencer par "cardinal" et finir par ".png"</small>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i>
                    Uploader le logo
                </button>
            </form>
        </div>
    </div>

    <!-- Logos List -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-list"></i>
                Logos existants ({{ logos|length }})
            </h2>

            <div class="card-actions">
                <button id="selectAllBtn" class="btn btn-secondary" onclick="toggleSelectAll()">
                    <i class="fas fa-check-square"></i>
                    Tout sélectionner
                </button>

                <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelectedLogos()" disabled>
                    <i class="fas fa-trash"></i>
                    Supprimer sélectionnés
                </button>
            </div>
        </div>

        <div class="card-content">
            {% if logos %}
            <div class="logos-grid">
                {% for logo in logos %}
                <div class="logo-item" data-filename="{{ logo.filename }}">
                    <div class="logo-checkbox">
                        <input
                            type="checkbox"
                            class="logo-select"
                            value="{{ logo.filename }}"
                            onchange="updateSelectedCount()"
                        >
                    </div>

                    <div class="logo-preview">
                        <img src="{{ url_for('logos', path=logo.filename) }}" alt="{{ logo.filename }}">
                    </div>

                    <div class="logo-info">
                        <h3 class="logo-name">{{ logo.filename }}</h3>
                        <div class="logo-details">
                            <span class="logo-size">{{ logo.size_mb }} MB</span>
                            <span class="logo-dimensions">{{ logo.dimensions }}</span>
                        </div>
                        <div class="logo-date">{{ logo.modified.strftime('%d/%m/%Y %H:%M') }}</div>
                    </div>

                    <div class="logo-actions">
                        <button
                            class="btn-icon"
                            title="Renommer"
                            onclick="renameLogo('{{ logo.filename }}')"
                        >
                            <i class="fas fa-edit"></i>
                        </button>

                        <button
                            class="btn-icon btn-danger"
                            title="Supprimer"
                            onclick="deleteSingleLogo('{{ logo.filename }}')"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-images"></i>
                <p>Aucun logo trouvé</p>
                <small>Uploadez votre premier logo ci-dessus</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Renommer le logo</h3>
        </div>
        <div class="modal-body">
            <form id="renameForm">
                <input type="hidden" id="renameOldName" value="">

                <div class="form-group">
                    <label for="renameNewName" class="form-label">Nouveau nom</label>
                    <input
                        type="text"
                        id="renameNewName"
                        class="form-input"
                        pattern="^cardinal.*\.png$"
                        required
                    >
                    <small class="form-help">Doit commencer par "cardinal" et finir par ".png"</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeRenameModal()" class="btn btn-secondary">Annuler</button>
            <button onclick="submitRename()" class="btn btn-primary">Renommer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-help {
    display: block;
    margin-top: 4px;
    color: #7f8c8d;
    font-size: 0.8rem;
}

.card-actions {
    display: flex;
    gap: 10px;
}

.logos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.logo-item {
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    padding: 16px;
    background: #f8f9fa;
    transition: all 0.2s ease;
    position: relative;
}

.logo-item:hover {
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.logo-item.selected {
    border-color: #667eea;
    background: #f0f4ff;
}

.logo-checkbox {
    position: absolute;
    top: 12px;
    right: 12px;
}

.logo-preview {
    text-align: center;
    margin-bottom: 12px;
}

.logo-preview img {
    max-width: 120px;
    max-height: 120px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.logo-info {
    text-align: center;
    margin-bottom: 12px;
}

.logo-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    word-break: break-all;
}

.logo-details {
    display: flex;
    justify-content: center;
    gap: 8px;
    font-size: 0.8rem;
    color: #7f8c8d;
    margin-bottom: 4px;
}

.logo-date {
    font-size: 0.7rem;
    color: #bdc3c7;
}

.logo-actions {
    display: flex;
    justify-content: center;
    gap: 8px;
}

.btn-icon {
    background: none;
    border: 1px solid #e1e8ed;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #5a6c7d;
}

.btn-icon:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.btn-icon.btn-danger:hover {
    background: #dc3545;
    border-color: #dc3545;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .logos-grid {
        grid-template-columns: 1fr;
    }

    .card-actions {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Upload form handling
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const result = await LogoManager.uploadLogo(formData);

    if (result.success) {
        this.reset();
    }
});

// File input validation
document.getElementById('logoFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > {{ max_upload_size_mb }} * 1024 * 1024) {
            showMessage(`Fichier trop volumineux. Maximum {{ max_upload_size_mb }}MB`, 'error');
            this.value = '';
            return;
        }

        if (!file.type.startsWith('image/png')) {
            showMessage('Seuls les fichiers PNG sont autorisés', 'error');
            this.value = '';
            return;
        }
    }
});

// Selection management
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.logo-select:checked');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const selectAllBtn = document.getElementById('selectAllBtn');

    deleteBtn.disabled = checkboxes.length === 0;

    // Update select all button text
    const allCheckboxes = document.querySelectorAll('.logo-select');
    if (checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
        selectAllBtn.innerHTML = '<i class="fas fa-square"></i> Tout désélectionner';
    } else {
        selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Tout sélectionner';
    }

    // Update visual selection
    document.querySelectorAll('.logo-item').forEach(item => {
        const checkbox = item.querySelector('.logo-select');
        if (checkbox.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

function toggleSelectAll() {
    const allCheckboxes = document.querySelectorAll('.logo-select');
    const checkedCheckboxes = document.querySelectorAll('.logo-select:checked');

    const shouldSelect = checkedCheckboxes.length !== allCheckboxes.length;

    allCheckboxes.forEach(checkbox => {
        checkbox.checked = shouldSelect;
    });

    updateSelectedCount();
}

function deleteSelectedLogos() {
    const checkboxes = document.querySelectorAll('.logo-select:checked');
    const logoNames = Array.from(checkboxes).map(cb => cb.value);

    LogoManager.deleteLogos(logoNames);
}

function deleteSingleLogo(filename) {
    LogoManager.deleteLogos([filename]);
}

// Rename functionality
function renameLogo(filename) {
    document.getElementById('renameOldName').value = filename;
    document.getElementById('renameNewName').value = filename;
    document.getElementById('renameModal').classList.add('show');
    document.getElementById('renameNewName').focus();
    document.getElementById('renameNewName').select();
}

function closeRenameModal() {
    document.getElementById('renameModal').classList.remove('show');
}

function submitRename() {
    const oldName = document.getElementById('renameOldName').value;
    const newName = document.getElementById('renameNewName').value;

    if (!newName || newName === oldName) {
        showMessage('Nouveau nom invalide', 'error');
        return;
    }

    if (!newName.match(/^cardinal.*\.png$/)) {
        showMessage('Le nom doit commencer par "cardinal" et finir par ".png"', 'error');
        return;
    }

    closeRenameModal();
    LogoManager.renameLogo(oldName, newName);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+A to select all
    if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        toggleSelectAll();
    }

    // Delete key to delete selected
    if (e.key === 'Delete') {
        const checkboxes = document.querySelectorAll('.logo-select:checked');
        if (checkboxes.length > 0) {
            deleteSelectedLogos();
        }
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
});
</script>
{% endblock %}
