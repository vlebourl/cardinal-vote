{% extends "admin/base.html" %}

{% block title %}Gestion des votes{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <h1 class="page-title">
            <i class="fas fa-vote-yea"></i>
            Gestion des votes
        </h1>
        <p class="page-subtitle">Vue d'ensemble et gestion des votes reçus</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-vote-yea"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ votes|length if votes else 0 }}</h3>
                <p class="stat-label">Total des votes</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ unique_voters if unique_voters else 0 }}</h3>
                <p class="stat-label">Votants uniques</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ avg_rating|round(1) if avg_rating else 0.0 }}</h3>
                <p class="stat-label">Note moyenne</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ recent_votes_count if recent_votes_count else 0 }}</h3>
                <p class="stat-label">Votes dernières 24h</p>
            </div>
        </div>
    </div>

    <!-- Export Actions -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-download"></i>
                Export des données
            </h2>
        </div>
        <div class="card-content">
            <div class="quick-actions">
                <button class="quick-action" onclick="exportVotes('csv')" {% if not votes %}disabled{% endif %}>
                    <i class="fas fa-file-csv"></i>
                    <span>Exporter CSV</span>
                </button>
                
                <button class="quick-action" onclick="exportVotes('json')" {% if not votes %}disabled{% endif %}>
                    <i class="fas fa-file-code"></i>
                    <span>Exporter JSON</span>
                </button>
                
                <button class="quick-action" onclick="clearAllVotes()" {% if not votes %}disabled{% endif %}>
                    <i class="fas fa-trash"></i>
                    <span>Vider tous les votes</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Votes List -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-list"></i>
                Liste des votes
            </h2>
            <div class="card-actions">
                {% if votes %}
                <button id="refreshVotes" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                    Actualiser
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-content">
            {% if votes %}
            <div class="votes-table-container">
                <table class="votes-table">
                    <thead>
                        <tr>
                            <th>Votant</th>
                            <th>Date/Heure</th>
                            <th>IP Address</th>
                            <th>Notes données</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vote in votes %}
                        <tr>
                            <td class="vote-name">
                                <strong>{{ vote.voter_name }}</strong>
                                {% if vote.voter_email %}
                                <small>{{ vote.voter_email }}</small>
                                {% endif %}
                            </td>
                            <td class="vote-timestamp">{{ vote.timestamp }}</td>
                            <td class="vote-ip">
                                <code>{{ vote.ip_address if vote.ip_address else 'N/A' }}</code>
                            </td>
                            <td class="vote-ratings">
                                {% if vote.ratings %}
                                    {% set positive_count = namespace(value=0) %}
                                    {% set negative_count = namespace(value=0) %}
                                    {% set neutral_count = namespace(value=0) %}
                                    {% for rating in vote.ratings.values() %}
                                        {% if rating >= 1 %}
                                            {% set positive_count.value = positive_count.value + 1 %}
                                        {% elif rating <= -1 %}
                                            {% set negative_count.value = negative_count.value + 1 %}
                                        {% else %}
                                            {% set neutral_count.value = neutral_count.value + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="vote-stat positive" title="Votes positifs">+{{ positive_count.value }}</span>
                                    <span class="vote-stat neutral" title="Votes neutres">={{ neutral_count.value }}</span>
                                    <span class="vote-stat negative" title="Votes négatifs">-{{ negative_count.value }}</span>
                                {% else %}
                                    <span class="vote-stat neutral">Aucune note</span>
                                {% endif %}
                            </td>
                            <td class="vote-actions">
                                <button class="btn btn-sm btn-info" onclick="viewVoteDetails('{{ vote.id }}')" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVote('{{ vote.id }}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Aucun vote enregistré</h3>
                <p>Les votes apparaîtront ici une fois que les utilisateurs auront commencé à voter.</p>
                <a href="/" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt"></i>
                    Aller au site de vote
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Vote Details Modal -->
<div id="voteDetailsModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="voteDetailsTitle">Détails du vote</h3>
            <button class="modal-close" onclick="closeVoteDetails()">&times;</button>
        </div>
        <div class="modal-body" id="voteDetailsBody">
            <!-- Vote details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeVoteDetails()">Fermer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Export votes functionality
async function exportVotes(format) {
    try {
        showLoading();
        
        const response = await fetch(`/admin/votes/export/${format}`, {
            headers: {
                'X-CSRF-Token': window.csrfToken
            }
        });
        
        if (response.ok) {
            // Trigger download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `votes_export_${new Date().toISOString().slice(0, 10)}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showMessage('Export réussi', 'success');
        } else {
            showMessage('Erreur lors de l\'export', 'error');
        }
    } catch (error) {
        console.error('Export error:', error);
        showMessage('Erreur lors de l\'export', 'error');
    } finally {
        hideLoading();
    }
}

// Clear all votes functionality
async function clearAllVotes() {
    if (!confirm('Êtes-vous sûr de vouloir supprimer TOUS les votes ? Cette action est irréversible.')) {
        return;
    }
    
    try {
        showLoading();
        
        const formData = new FormData();
        formData.append('csrf_token', window.csrfToken);
        
        const response = await fetch('/admin/votes/clear', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Tous les votes ont été supprimés', 'success');
            // Reload the page to reflect changes
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showMessage(result.message || 'Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Clear votes error:', error);
        showMessage('Erreur lors de la suppression', 'error');
    } finally {
        hideLoading();
    }
}

// View vote details
async function viewVoteDetails(voteId) {
    try {
        showLoading();
        
        const response = await fetch(`/admin/votes/${voteId}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-CSRF-Token': window.csrfToken || '',
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                displayVoteDetails(data.vote);
            } else {
                showMessage(data.message || 'Erreur lors de la récupération des détails', 'error');
            }
        } else if (response.status === 401) {
            // Authentication error - redirect to login
            showMessage('Session expirée. Redirection vers la page de connexion...', 'warning');
            setTimeout(() => {
                window.location.href = '/admin/login';
            }, 2000);
        } else if (response.status === 404) {
            showMessage('Vote introuvable', 'error');
        } else {
            showMessage('Erreur lors de la récupération des détails', 'error');
        }
    } catch (error) {
        console.error('View vote details error:', error);
        showMessage('Erreur lors de la récupération des détails', 'error');
    } finally {
        hideLoading();
    }
}

// Display vote details in modal
function displayVoteDetails(vote) {
    const title = document.getElementById('voteDetailsTitle');
    const body = document.getElementById('voteDetailsBody');
    
    title.textContent = `Vote de ${vote.voter_name}`;
    
    let ratingsHtml = '<div class="vote-details-ratings">';
    if (vote.ratings && Object.keys(vote.ratings).length > 0) {
        ratingsHtml += '<h4>Notes par logo:</h4><div class="ratings-grid">';
        for (const [logo, rating] of Object.entries(vote.ratings)) {
            const ratingClass = rating >= 1 ? 'positive' : rating <= -1 ? 'negative' : 'neutral';
            ratingsHtml += `
                <div class="rating-item">
                    <span class="rating-logo">${logo}</span>
                    <span class="rating-value ${ratingClass}">${rating}</span>
                </div>
            `;
        }
        ratingsHtml += '</div>';
    } else {
        ratingsHtml += '<p>Aucune note enregistrée</p>';
    }
    ratingsHtml += '</div>';
    
    body.innerHTML = `
        <div class="vote-details">
            <div class="vote-detail-row">
                <strong>Nom:</strong> ${vote.voter_name}
            </div>
            ${vote.voter_email ? `<div class="vote-detail-row"><strong>Email:</strong> ${vote.voter_email}</div>` : ''}
            <div class="vote-detail-row">
                <strong>Date/Heure:</strong> ${vote.timestamp}
            </div>
            <div class="vote-detail-row">
                <strong>Adresse IP:</strong> ${vote.ip_address || 'N/A'}
            </div>
            ${ratingsHtml}
        </div>
    `;
    
    document.getElementById('voteDetailsModal').style.display = 'block';
}

// Close vote details modal
function closeVoteDetails() {
    document.getElementById('voteDetailsModal').style.display = 'none';
}

// Delete single vote
async function deleteVote(voteId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce vote ?')) {
        return;
    }
    
    try {
        showLoading();
        
        const response = await fetch(`/admin/votes/${voteId}`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRF-Token': window.csrfToken || '',
                'Accept': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Vote supprimé avec succès', 'success');
            // Reload the page to reflect changes
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showMessage(result.message || 'Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Delete vote error:', error);
        showMessage('Erreur lors de la suppression', 'error');
    } finally {
        hideLoading();
    }
}

// Refresh votes
document.getElementById('refreshVotes')?.addEventListener('click', function() {
    window.location.reload();
});

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('voteDetailsModal');
    if (event.target === modal) {
        closeVoteDetails();
    }
});
</script>
{% endblock %}